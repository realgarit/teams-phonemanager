<UserControl xmlns="https://github.com/avaloniaui"
             x:Class="teams_phonemanager.Views.BulkOperationsView"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
             xmlns:fi="using:FluentIcons.Avalonia"
             xmlns:fic="using:FluentIcons.Common"
             xmlns:local="clr-namespace:teams_phonemanager.Views"
             xmlns:viewmodels="clr-namespace:teams_phonemanager.ViewModels"
             xmlns:converters="clr-namespace:teams_phonemanager.Converters"
             mc:Ignorable="d" 
             d:DesignHeight="700" d:DesignWidth="900">

    <UserControl.Resources>
        <converters:BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter"/>
    </UserControl.Resources>

    <Grid>
        <Border Classes="card" Margin="0">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>

                <!-- Header -->
                <StackPanel Grid.Row="0" Margin="24,24,24,16">
                    <TextBlock Text="Bulk Operations" 
                             Classes="page-title"/>
                    <TextBlock Text="Import a CSV file to create multiple phone system setups at once. Each row defines a complete configuration (M365 Group, Resource Accounts, Call Queue, Auto Attendant)."
                             TextWrapping="Wrap"
                             Foreground="{DynamicResource TextFillColorSecondaryBrush}"
                             Margin="0,4,0,12"/>

                    <!-- Action Buttons -->
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <Button Command="{Binding ExportTemplateFileCommand}" Classes="IconText">
                            <StackPanel Orientation="Horizontal">
                                <fi:SymbolIcon Symbol="ArrowDownload" Foreground="{DynamicResource TextFillColorPrimaryBrush}"/>
                                <TextBlock Text="Download Template" VerticalAlignment="Center"/>
                            </StackPanel>
                        </Button>
                        <Button Command="{Binding ImportCsvFileCommand}" Classes="IconText">
                            <StackPanel Orientation="Horizontal">
                                <fi:SymbolIcon Symbol="ArrowUpload" Foreground="{DynamicResource TextFillColorPrimaryBrush}"/>
                                <TextBlock Text="Import CSV" VerticalAlignment="Center"/>
                            </StackPanel>
                        </Button>
                        <Button Command="{Binding GenerateTemplateCommand}" Classes="IconText">
                            <StackPanel Orientation="Horizontal">
                                <fi:SymbolIcon Symbol="DocumentAdd" Foreground="{DynamicResource TextFillColorPrimaryBrush}"/>
                                <TextBlock Text="Generate Template" VerticalAlignment="Center"/>
                            </StackPanel>
                        </Button>
                        <Button Command="{Binding ParseCsvCommand}" IsEnabled="{Binding !IsBusy}" Classes="IconText">
                            <StackPanel Orientation="Horizontal">
                                <fi:SymbolIcon Symbol="TableSearch" Foreground="{DynamicResource TextFillColorPrimaryBrush}"/>
                                <TextBlock Text="Parse CSV" VerticalAlignment="Center"/>
                            </StackPanel>
                        </Button>
                        <Button Command="{Binding PreviewScriptCommand}" IsEnabled="{Binding !IsBusy}" Classes="IconText">
                            <StackPanel Orientation="Horizontal">
                                <fi:SymbolIcon Symbol="Eye" Foreground="{DynamicResource TextFillColorPrimaryBrush}"/>
                                <TextBlock Text="Preview Script" VerticalAlignment="Center"/>
                            </StackPanel>
                        </Button>
                        <Button Command="{Binding ExecuteAllCommand}" 
                                Classes="IconText"
                                IsEnabled="{Binding !IsBusy}">
                            <StackPanel Orientation="Horizontal">
                                <fi:SymbolIcon Symbol="Play" Foreground="{DynamicResource TextFillColorPrimaryBrush}"/>
                                <TextBlock Text="Execute All" VerticalAlignment="Center"/>
                            </StackPanel>
                        </Button>
                    </StackPanel>

                    <!-- Status -->
                    <TextBlock Text="{Binding StatusMessage}"
                             Margin="0,10,0,0"
                             FontSize="13"
                             Foreground="{DynamicResource TextFillColorSecondaryBrush}"
                             IsVisible="{Binding StatusMessage, Converter={x:Static StringConverters.IsNotNullOrEmpty}}"/>
                    
                    <!-- Progress -->
                    <ProgressBar IsIndeterminate="True"
                                 IsVisible="{Binding IsExecuting}"
                                 Margin="0,6,0,0"/>
                </StackPanel>

                <!-- Content Tabs -->
                <TabControl Grid.Row="1" Margin="24,0,24,24">
                    
                    <!-- CSV Editor Tab -->
                    <TabItem Header="CSV Data">
                        <Border Background="{DynamicResource ControlFillColorDefaultBrush}"
                                BorderBrush="{DynamicResource CardStrokeColorDefaultBrush}"
                                BorderThickness="1"
                                CornerRadius="0,0,8,8"
                                Margin="0">
                            <TextBox Text="{Binding CsvContent}"
                                     AcceptsReturn="True"
                                     TextWrapping="NoWrap"
                                     FontFamily="Cascadia Code, Consolas, Courier New, monospace"
                                     FontSize="12"
                                     BorderThickness="0"
                                     Padding="12"
                                     Watermark="Paste CSV content here, or use Import/Generate buttons above..."/>
                        </Border>
                    </TabItem>

                    <!-- Parsed Entries Tab -->
                    <TabItem Header="Parsed Entries">
                        <DataGrid ItemsSource="{Binding ParsedEntries}"
                                  AutoGenerateColumns="False"
                                  IsReadOnly="True"
                                  GridLinesVisibility="Horizontal"
                                  CanUserResizeColumns="True"
                                  CanUserSortColumns="True">
                            <DataGrid.Columns>
                                <DataGridTextColumn Header="Customer" Binding="{Binding Customer}" Width="120"/>
                                <DataGridTextColumn Header="Group" Binding="{Binding GroupName}" Width="120"/>
                                <DataGridTextColumn Header="M365 Group" Binding="{Binding M365Group}" Width="180"/>
                                <DataGridTextColumn Header="Call Queue" Binding="{Binding CqDisplayName}" Width="180"/>
                                <DataGridTextColumn Header="Auto Attendant" Binding="{Binding AaDisplayName}" Width="200"/>
                                <DataGridTextColumn Header="Phone" Binding="{Binding PhoneNumber}" Width="140"/>
                                <DataGridTextColumn Header="Language" Binding="{Binding Language}" Width="80"/>
                            </DataGrid.Columns>
                        </DataGrid>
                    </TabItem>

                    <!-- Script Preview Tab -->
                    <TabItem Header="Script Preview">
                        <Border Background="{DynamicResource ControlFillColorDefaultBrush}"
                                BorderBrush="{DynamicResource CardStrokeColorDefaultBrush}"
                                BorderThickness="1"
                                CornerRadius="0,0,8,8">
                            <ScrollViewer HorizontalScrollBarVisibility="Auto"
                                          VerticalScrollBarVisibility="Auto">
                                <TextBox Text="{Binding ScriptPreview}"
                                         IsReadOnly="True"
                                         AcceptsReturn="True"
                                         TextWrapping="NoWrap"
                                         FontFamily="Cascadia Code, Consolas, Courier New, monospace"
                                         FontSize="12"
                                         BorderThickness="0"
                                         Padding="12"
                                         Watermark="Click 'Preview Script' to see the generated PowerShell..."/>
                            </ScrollViewer>
                        </Border>
                    </TabItem>

                    <!-- Execution Log Tab -->
                    <TabItem Header="Execution Log">
                        <Border Background="{DynamicResource ControlFillColorDefaultBrush}"
                                BorderBrush="{DynamicResource CardStrokeColorDefaultBrush}"
                                BorderThickness="1"
                                CornerRadius="0,0,8,8">
                            <ScrollViewer HorizontalScrollBarVisibility="Auto"
                                          VerticalScrollBarVisibility="Auto">
                                <TextBox Text="{Binding ExecutionLog}"
                                         IsReadOnly="True"
                                         AcceptsReturn="True"
                                         TextWrapping="Wrap"
                                         FontFamily="Cascadia Code, Consolas, Courier New, monospace"
                                         FontSize="12"
                                         BorderThickness="0"
                                         Padding="12"
                                         Watermark="Execution output will appear here after running..."/>
                            </ScrollViewer>
                        </Border>
                    </TabItem>
                </TabControl>
            </Grid>
        </Border>
    </Grid>
</UserControl>
